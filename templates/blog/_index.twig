{% extends '_layout' %}

{% set postsPerPage = 8 %}

{% set categorySlug = craft.app.request.segments | last %}
{% set isHomepage = categorySlug | length == 0 %}
{% set categories = craft.entries.section('category') %}

{% if isHomepage %}
	{% set blogQuery = craft.entries.section('blog') %}
{% else %}
	{% if not entry.show %}
		{% redirect '/' %}
	{% endif %}
	{% set categoryEntry = craft.entries.section('category').slug(categorySlug) %}
	{% set blogQuery = craft.entries.section('blog').relatedTo(categoryEntry) %}
{% endif %}

{% paginate blogQuery.limit(1) as firstPageInfo, tempPosts %}

{% if isHomepage %}
	{% if firstPageInfo.currentPage == 1 %}
		{% paginate blogQuery.limit(postsPerPage + 1).orderBy('postDate DESC') as pageInfo, posts %}
	{% else %}
		{% paginate blogQuery.limit(postsPerPage).offset(1).orderBy('postDate DESC') as pageInfo, posts %}
	{% endif %}
{% else %}
	{% paginate blogQuery.limit(postsPerPage).orderBy('postDate DESC') as pageInfo, posts %}
{% endif %}

{% if entry.section.handle != 'homepage' %}
	{% set pageTitle = entry.title %}
{% endif %}

{% block scripts %}
	{% if isHomepage %}
		<script type="text/javascript">
			if (typeof(bp) === 'object')
			{
				bp.createBandCarousels();
			}
		</script>
	{% endif %}
{% endblock %}

{% block content %}

	{% include '_includes/categories' with { categories: categories } %}

	<div class="container">
		{% if isHomepage and pageInfo.currentPage == 1 %}
			{% set featured = posts[0] %}

			<h3 class="section-title"><span>Featured Article</span></h3>

			<article class="featured">
				<a class="blog-image" href="{{ featured.url }}">
					{% if featured.blogImage.count %}
						<img src="{{ featured.blogImage.one().url('featuredPost') }}" alt="{{ featured.blogImage.one().title }}" 
							width="{{ featured.blogImage.one().width('featuredPost') }}" 
							height="{{ featured.blogImage.one().height('featuredPost') }}">
					{% endif %}
					<div class="blog-image-info display-md"{% if featured.opacity > 0 %} style="background-color: rgba(0, 0, 0, {{ featured.opacity }});"{% endif %}>
						<h2>
							{# {{ featured.title }} #}
							{{ featured.title ~ (featured.subheadline | length ? ' - '  ~ featured.subheadline : '') }}
						</h2>
						{% include '_includes/author' with { blog: featured, showLink: false } %}
						<p>{{ featured.shortDescription }}</p>
					</div>
				</a>
				<div class="blog-info">
					<ul>
	            		{% for cat in featured.categories.all() %}
	            			<li>
			            		{% if cat.show %}
	            					<a href="{{ cat.url }}">{{ cat.title }}</a>{% if not loop.last %}, {% endif %}
	            				{% else %}
	            					<span>{{ cat.title }}</span>{% if not loop.last %}, {% endif %}
	            				{% endif %}
	            			</li>
	            		{% endfor %}
	            	</ul>
					<div class="hide-md">
						<h3>
							<a href="{{ featured.url }}">
								{{ featured.title ~ (featured.subheadline | length ? ' '  ~ featured.subheadline : '') }}
							</a>
						</h3>
						{% include '_includes/author' with { blog: featured } %}
						<p>{{ featured.shortDescription }}</p>
					</div>
				</div>
			</article>
		{% endif %}

		{% if isHomepage %}
			<h3 class="section-title"><span>Recent Articles</span></h3>
		{% elseif entry.headline | length > 0 or entry.shortDescription | length > 0 %}
			<div class="page container">
				<section class="description">
					{% if entry.headline | length > 0 %}
						<h2><span>{{ entry.headline }}</span></h2>
					{% endif %}
					{% if entry.shortDescription | length > 0 %}
						<div class="narrow-container">
							<h4>{{ entry.shortDescription }}</h4>
						</div>
					{% endif %}
				</section>
			</div>
		{% endif %}

		<div class="blog-posts">
			{% for blog in (isHomepage and pageInfo.currentPage == 1 ? posts[1:] : posts) %}
	            <article>
					<a class="blog-image" href="{{ blog.url }}">
						{% if blog.blogImage.count %}
							<img src="{{ blog.blogImage.one().url('blogPost') }}" alt="{{ blog.blogImage.one().title }}"
								width="{{ blog.blogImage.one().width('blogPost') }}" 
								height="{{ blog.blogImage.one().height('blogPost') }}">
						{% endif %}
					</a>
					<div class="blog-info">
						<ul>
		            		{% for cat in blog.categories.all() %}
		            			{% apply spaceless %}
			            			<li>
			            				{% if cat.show %}
			            					<a href="{{ cat.url }}">{{ cat.title }}</a>{% if not loop.last %}, {% endif %}
			            				{% else %}
			            					<span href="{{ cat.url }}">{{ cat.title }}</span>{% if not loop.last %}, {% endif %}
			            				{% endif %}
			            			</li>
			            		{% endapply %}
		            		{% endfor %}
		            	</ul>
						<h3>
							<a href="{{ blog.url }}">
								{{ blog.title ~ (blog.subheadline | length > 8 ? ' - '  ~ blog.subheadline : '') }}
							</a>
						</h3>
						
						{% include '_includes/author' %}

						<p>{{ blog.shortDescription }}</p>
					</div>
				</article>
	        {% endfor %}
          </div>
	</div>

	{% if pageInfo.total > (postsPerPage + 1) %}
		<div class="container">
	    	{% include '_includes/pagination' %}
	    </div>
	{% endif %}

	{% if isHomepage and pageInfo.currentPage == 1 %}
		{% include '_includes/band-carousel' %}
	{% endif %}

{% endblock %}