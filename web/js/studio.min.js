class Studio{static RELATED_POSTS_URL="/api/studio-blog-search";static SAVE_KEYWORD_URL="/bands/save-keyword";static FILTER_TYPES={roles:"roles",skill:"skill",goals:"goals"};static LOAD_MESSAGES=["Customizing your goals with harmonic data...","Assembling digital sound bytes, specifically for you...","Streaming melodic sequences, please wait...","Creating custom tips with rhythmic patterns...","Disecting your unique musical algorithm...","Please hold while we teach AI jazz theory...","Sorry for the delay, AI is tuning its guitar...","Composing your custom binary symphonies...","Patience is bitter, but its fruit is sweet...","Rome wasn't built in a day, and apparently neither was AI..."];static KEYWORD_SUBTITLES={first:["Essential","Useful","Helpful","Valuable"],last:["Tips","Information","Advice","Insights"]};constructor(e,t,i,n,s,r){if("object"==typeof r)return void this.loadKeyword(r);const o=e.trim().length>0;this.dirtyFilters=!1,this.goalValues=s,this.createFilters(),o?(this.dirtyFilters=!0,history.replaceState({},null,window.location.pathname),this.hasCachedAIData()&&this.loadContent(),this.openMenu()):this.hasCachedFilters()?(this.loadCachedFilters(),this.hasCachedAIData()?this.loadContent():this.openMenu()):this.openMenu()}static get data(){return(new Studio).getCachedData()}getCachedData(){let e={filters:{},ai:{}};if(this.hasOwnProperty("filterData"))e.filters=this.filterData;else{const t=localStorage.getItem(BandPioneer.STUDIO_FILTER_KEY);e.filters=JSON.parse(t)??{}}if(this.hasOwnProperty("aiData"))e.ai=this.aiData;else{const t=localStorage.getItem(BandPioneer.STUDIO_AI_KEY);e.ai=JSON.parse(t)??{}}return e}getCachedKeywordData(){const e=localStorage.getItem(BandPioneer.STUDIO_DYNAMIC_KEY);return JSON.parse(e)??null}hasCachedFilters(){return null!==localStorage.getItem(BandPioneer.STUDIO_FILTER_KEY)}hasCachedAIData(){return null!==localStorage.getItem(BandPioneer.STUDIO_AI_KEY)}saveFilterData(){const e=this.getDataObjFromUX();0===Object.keys(e).length?this.deleteFilterData():localStorage.setItem(BandPioneer.STUDIO_FILTER_KEY,JSON.stringify(e))}deleteFilterData(){localStorage.removeItem(BandPioneer.STUDIO_FILTER_KEY),localStorage.removeItem(BandPioneer.STUDIO_AI_KEY)}saveAIData(e,t,i=""){const n={intro:t,title:e,goals:i};localStorage.setItem(BandPioneer.STUDIO_AI_KEY,JSON.stringify(n))}saveKeywordData(e){let t=document.querySelector('meta[name="csrf-token-name"]').getAttribute("content"),i=document.querySelector('meta[name="csrf-token-value"]').getAttribute("content"),n=new FormData;n.append("path",e.path),n.append("title",e.subtitle),n.append("body",e.body),n.append("description",e.description),n.append(t,i),fetch(Studio.SAVE_KEYWORD_URL,{method:"POST",body:n}).then((e=>e.text())).catch((e=>console.error("Error:",e)))}getDataObjFromUX(){const e=document.querySelectorAll('input[name="filterRoles"], input[name="filterSkill"], input[name="filterGoals"]');return Array.from(e).reduce(((e,t)=>(t.checked&&(e.hasOwnProperty(t.name)||(e[t.name]=[]),e[t.name].push(t.value)),e)),{})}loadCachedFilters(){const e=this.getCachedData().filters;if(Object.keys(e).length>0){for(const t in e)e.hasOwnProperty(t)&&e[t].forEach((e=>{const i=document.querySelector(`input[name="${t}"][value="${e}"]`);i&&(i.checked=!0)}));return!0}return!1}async aiRequest(e,t){const i=await BandPioneer.aiQuery(e);if("function"!=typeof t)return i;t(i)}resetUI(){document.querySelector("#role-articles > div").innerHTML="",document.querySelector("#recent-articles").style.display="block",document.getElementById("intro-tips").innerHTML=""}loadKeyword(e){const t=document.querySelector("#intro-role"),i=document.querySelector("#intro-description"),n=document.querySelector("#recent-articles"),s=document.querySelector("#intro-spinner svg"),r=n.querySelectorAll("article");if(r.length){let e=r[0].querySelector(".blog-info ul li:first-child a");n.innerHTML+=this.getReadMoreLink(e.href)}if(e.subtitle.length>0&&e.body.length>0)i.classList.add("text-left"),i.innerHTML=e.body,t.innerText=e.subtitle;else{t.innerText="Something magical is happening!",i.innerHTML="Through the power of BandPioneer and AI we are customizing this content, specifically for you...",s.style.display="inline";const n=this,r=`Write a 5 to 15 paragraph essay about "${e.title}". The content must be practical and extremely insightful, and written as a sequence of paragraphs without a title or section headers. Make the last sentence a compelling CTA to read the articles below this text to learn more. `,o=`In less than 155 characters, write thought provoking copy about quick tips on "${e.title}". This needs to be SEO friendly copy only, and less than 155 characters to be used as the value for a description meta tag. No hashtags.`;(async()=>{let[a,l]=await Promise.all([BandPioneer.aiQuery(r),BandPioneer.aiQuery(o)]),c=Math.floor(Math.random()*Studio.KEYWORD_SUBTITLES.first.length);if(e.subtitle=`${Studio.KEYWORD_SUBTITLES.first[c]} ${e.query} ${Studio.KEYWORD_SUBTITLES.last[c]}`,t.innerText=e.subtitle,s.style.display="none","error"===l&&(l="Music Industry Insights and Marketing Tips for Profitable Musicians"),"error"!==a){const t=a.split(".").filter((e=>""!==e.trim())).pop();a=a.replace(t,`<strong>${t}</strong>`),i.classList.add("text-left"),i.innerHTML=a,e.body=a,e.description=l,n.saveKeywordData(e)}else i.innerHTML="<h4>We are unable to create your persona at this time.</h4>We apologize for the inconvenience, and will look into it promptly. Please try again later."})()}}loadContent(e=!1){const t=this,i=this.getCachedData(),n=i.filters.hasOwnProperty("filterRoles")?i.filters.filterRoles.join(" and "):"musician";if(!e&&i.ai.hasOwnProperty("title")&&i.ai.hasOwnProperty("intro"))document.getElementById("intro-role").innerHTML=i.ai.title,t.loadAITipsHtml(i.ai.goals,n);else{this.resetUI();let e="I am a ";i.filters.hasOwnProperty("filterSkill")&&(e+=i.filters.filterSkill.join(" to ")+" "),e+=n+" ",i.filters.hasOwnProperty("filterGoals")&&(e+="with goals to "+i.filters.filterGoals.join(" and ")+". "),document.getElementById("intro-role").innerText="Creating Your Music Persona",document.getElementById("intro-description").innerHTML="<h4>Something magical is happening!</h4>Through the power of BandPioneer and AI we are customizing this content, specifically for you...",document.querySelector("#intro-spinner svg").style.display="inline",(async()=>{let s=await BandPioneer.aiQuery(`${e} Create a job title for me using my roles or instruments. It must be less than 50 characters.`),r="";s=s.trim().replace(/\.$/,""),document.querySelector("#intro-spinner svg").style.display="none","error"!==s&&(document.getElementById("intro-role").innerHTML=s.trim().replace(/\.$/,"")),r.length>0&&(document.getElementById("intro-description").innerHTML=r.trim());t.loadAITips(i,n,s,r)||"error"===s||t.saveAIData(s,r),t.dirtyFilters=!1})()}"musician"!=n&&this.renderPrimaryArticles(n)}renderPrimaryArticles(e){this.fetchRelatedPosts(Studio.FILTER_TYPES.roles,e,(function(e){0===e.trim().length?(document.querySelector("#role-articles > div").innerHTML="",document.querySelector("#recent-articles").style.display="block"):(document.querySelector("#recent-articles").style.display="none",document.querySelector("#role-articles > div").innerHTML=e)}))}loadAITipsHtml(e,t){const i=this,n=["How to","Ways to","How I can"];let s=Math.floor(Math.random()*n.length),r=0;const o=document.getElementById("intro-tips");o.innerHTML="",BandPioneer.each(e,(function(){s=++s>n.length-1?0:s;let e=t.split(" and ");if(e.length>2){let i=e.pop();t=e.join(", ")+" and "+i}const a="tip-articles-"+ ++r;let l=o.innerHTML;l+=`<section class="studio-tips"><h3>${n[s]} ${this.goal}</h3><strong>As a ${t}</strong><p>${this.tips}</p></section><div id="${a}"></div>`,o.innerHTML=l,i.fetchRelatedPosts(Studio.FILTER_TYPES.goals,this.goal,function(e){let t="/advice";switch(this.goal){case"make money with music":t="/finance";break;case"market and promote my music":case"influence on social media":t="/marketing"}const n=`${e}${i.getReadMoreLink(t)}`;document.getElementById(this.id).innerHTML=0===e.trim().length?"":n}.bind({id:a,goal:this.goal}))}))}getReadMoreLink(e){return`<div style="margin-top:40px;text-align:center;"><a class="btn" href="${e}">Read More Like This</a></div>`}startTipsSpinner(e){void 0===this.tipsy&&(this.tipsy={spinning:!1,spinner:document.querySelector("#tips-spinner"),svg:document.querySelector("#tips-spinner svg"),msg:document.querySelector("#tips-spinner strong"),loadMsg:function(){this.tipsy.spinning&&(this.tipsy.spinner.classList.remove("show"),setTimeout(function(){let e=Math.floor(Math.random()*Studio.LOAD_MESSAGES.length);this.tipsy.msg.innerText=Studio.LOAD_MESSAGES[e],this.tipsy.spinner.classList.add("show"),setTimeout(function(){this.tipsy.loadMsg()}.bind(this),5e3)}.bind(this),750))}.bind(this)}),e?(this.tipsy.spinning=!0,this.tipsy.loadMsg(),this.tipsy.svg.style.display="inline",this.tipsy.spinner.style.display="block"):(this.tipsy.spinning=!1,this.tipsy.svg.style.display="none",this.tipsy.spinner.style.display="none")}loadAITips(e,t,i,n){const s=this;let r=[];if(e.filters.hasOwnProperty("filterGoals")){const o=e.filters.filterGoals;if(o.length>0){function a(e){let l=`I am a ${t}. Provide a couple tips for how I can ${o[e]}?`;s.aiRequest(l,function(l){"error"!==l&&(r.push({goal:this.goal,tips:l}),++e<o.length?a(e):(s.startTipsSpinner(!1),s.loadAITipsHtml(r,t),s.saveAIData(i,n,r)))}.bind({idx:e,goal:o[e]}))}s.startTipsSpinner(!0),a(0)}return!0}return!1}fetchRelatedPosts(e,t,i){e===Studio.FILTER_TYPES.roles&&(t=t.replace(/ and /g,"~"));const n=`${Studio.RELATED_POSTS_URL}?type=${e}&filters=${t}`;fetch(n).then((e=>{if(e.ok)return e.text()})).then((e=>{i(e)})).catch((e=>{console.error("Error:",e)}))}goAction(){let e=document.querySelectorAll('input[name="filterRoles"]:checked').length>0,t=document.querySelectorAll('input[name="filterGoals"]:checked').length>0;function i(e){"undefined"!=typeof bp?bp.alert(e,function(){this.openMenu()}.bind(this)):alert(e)}i=i.bind(this),e&&t?this.dirtyFilters||!this.hasCachedAIData()?this.loadContent(!0):i("Select a different role, skill level<br>or goal to update your results."):i("You must at least select 1 role and goal.")}openMenu(){BandPioneer.each(document.querySelectorAll(".filter-group"),(function(){"filter-roles"===this.id?this.classList.add("show"):this.classList.remove("show")})),document.querySelector("#category-description").classList.add("show")}createFilters(){const e=this;let t=document.querySelectorAll("#filters nav ul li label");const i=document.querySelector("#filter-next");if(t.length){const n=document.querySelector("#category-description"),s=document.querySelectorAll(".filter-group");document.querySelector("#close-filters").addEventListener("click",function(e){e.preventDefault(),this.classList.remove("show")}.bind(n)),i.addEventListener("click",function(t){for(let i=0;i<s.length;i++)if(s[i].classList.contains("show")){if(s[i].classList.remove("show"),i===s.length-1){n.classList.remove("show"),e.goAction();break}if(i<s.length-1){t.target.innerText=i+1===s.length-1?"GO!":"Next",s[i+1].classList.add("show");break}}}.bind(n)),BandPioneer.each(t,(function(){this.addEventListener("click",function(t){"load-data"===t.target.dataset.filter?(this.classList.remove("show"),e.goAction()):(i.innerText="#filter-goals"===t.target.dataset.filter?"GO!":"Next",BandPioneer.each(s,(function(){this.classList.remove("show")})),this.querySelector(t.target.dataset.filter).classList.add("show"),this.classList.add("show"))}.bind(n))})),BandPioneer.each(s,(function(){let t=this.querySelector(".filter-inputs"),i=t.dataset.max;this.filterInputs=t.querySelectorAll('label input[type="checkbox"]'),BandPioneer.each(this.filterInputs,function(t,i){i.addEventListener("change",function(t){t.preventDefault(),e.dirtyFilters=!0;const n=Array.from(this.inputs).filter((function(e){return e.checked}));n.length>this.max&&(i===n[0]?n[1].checked=!1:n[0].checked=!1),e.saveFilterData()}.bind(this))}.bind({inputs:this.filterInputs,max:i}))}))}}}
