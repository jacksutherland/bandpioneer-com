/*! For license information please see MatrixInput.js.LICENSE.txt */
!function(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e,n,r){return(n=function(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}(n))in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function n(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,a=function(){};return{s:a,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,s=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw s}}}}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function i(){"use strict";i=function(){return n};var e,n={},r=Object.prototype,a=r.hasOwnProperty,s=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},l=o.iterator||"@@iterator",d=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(e){u=function(t,e,n){return t[e]=n}}function h(t,e,n,r){var i=e&&e.prototype instanceof b?e:b,a=Object.create(i.prototype),o=new L(r||[]);return s(a,"_invoke",{value:T(t,n,o)}),a}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}n.wrap=h;var p="suspendedStart",y="suspendedYield",m="executing",v="completed",g={};function b(){}function $(){}function E(){}var x={};u(x,l,(function(){return this}));var C=Object.getPrototypeOf,w=C&&C(C(O([])));w&&w!==r&&a.call(w,l)&&(x=w);var I=E.prototype=b.prototype=Object.create(x);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function M(e,n){function r(i,s,o,l){var d=f(e[i],e,s);if("throw"!==d.type){var c=d.arg,u=c.value;return u&&"object"==t(u)&&a.call(u,"__await")?n.resolve(u.__await).then((function(t){r("next",t,o,l)}),(function(t){r("throw",t,o,l)})):n.resolve(u).then((function(t){c.value=t,o(c)}),(function(t){return r("throw",t,o,l)}))}l(d.arg)}var i;s(this,"_invoke",{value:function(t,e){function a(){return new n((function(n,i){r(t,e,n,i)}))}return i=i?i.then(a,a):a()}})}function T(t,n,r){var i=p;return function(a,s){if(i===m)throw Error("Generator is already running");if(i===v){if("throw"===a)throw s;return{value:e,done:!0}}for(r.method=a,r.arg=s;;){var o=r.delegate;if(o){var l=k(o,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===p)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=m;var d=f(t,n,r);if("normal"===d.type){if(i=r.done?v:y,d.arg===g)continue;return{value:d.arg,done:r.done}}"throw"===d.type&&(i=v,r.method="throw",r.arg=d.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=f(i,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var s=a.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function B(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(B,this),this.reset(!0)}function O(n){if(n||""===n){var r=n[l];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,s=function t(){for(;++i<n.length;)if(a.call(n,i))return t.value=n[i],t.done=!1,t;return t.value=e,t.done=!0,t};return s.next=s}}throw new TypeError(t(n)+" is not iterable")}return $.prototype=E,s(I,"constructor",{value:E,configurable:!0}),s(E,"constructor",{value:$,configurable:!0}),$.displayName=u(E,c,"GeneratorFunction"),n.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===$||"GeneratorFunction"===(e.displayName||e.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,E):(t.__proto__=E,u(t,c,"GeneratorFunction")),t.prototype=Object.create(I),t},n.awrap=function(t){return{__await:t}},S(M.prototype),u(M.prototype,d,(function(){return this})),n.AsyncIterator=M,n.async=function(t,e,r,i,a){void 0===a&&(a=Promise);var s=new M(h(t,e,r,i),a);return n.isGeneratorFunction(e)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},S(I),u(I,c,"Generator"),u(I,l,(function(){return this})),u(I,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},n.values=O,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&a.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(r,i){return o.type="throw",o.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],o=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var l=a.call(s,"catchLoc"),d=a.call(s,"finallyLoc");if(l&&d){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!d)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&a.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),A(n),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;A(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:O(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},n}function a(t,e,n,r,i,a,s){try{var o=t[a](s),l=o.value}catch(t){return void n(t)}o.done?e(l):Promise.resolve(l).then(r,i)}function s(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var s=t.apply(e,n);function o(t){a(s,r,i,o,l,"next",t)}function l(t){a(s,r,i,o,l,"throw",t)}o(void 0)}))}}var o;o=jQuery,Craft.MatrixInput=Garnish.Base.extend({id:null,entryTypes:null,entryTypesByHandle:null,inputNamePrefix:null,inputIdPrefix:null,showingAddEntryMenu:!1,addEntryBtnGroupWidth:null,addEntryBtnContainerWidth:null,$container:null,$form:null,$entriesContainer:null,$addEntryBtnContainer:null,$addEntryBtn:null,$addEntryMenuBtn:null,$pasteBtn:null,$statusMessage:null,entrySort:null,entrySelect:null,elementEditor:null,addingEntry:!1,init:function(t,e,n,r){var a=this;this.id=t,this.entryTypes=e,this.inputNamePrefix=n,this.inputIdPrefix=Craft.formatInputId(this.inputNamePrefix),"number"==typeof r&&(r={maxEntries:r}),this.setSettings(r,Craft.MatrixInput.defaults),this.$container=o("#"+this.id),this.$form=this.$container.closest("form"),this.$entriesContainer=this.$container.children(".blocks"),this.$addEntryBtnContainer=this.$container.children(".buttons"),this.$addEntryBtn=this.$addEntryBtnContainer.children(".btn:not(.menubtn)"),this.$addEntryMenuBtn=this.$addEntryBtnContainer.children(".menubtn"),this.$statusMessage=this.$container.find("[data-status-message]"),this.$container.data("matrix",this),this.entryTypesByHandle={};for(var l=0;l<this.entryTypes.length;l++){var d=this.entryTypes[l];this.entryTypesByHandle[d.handle]=d}var c=this.$entriesContainer.children(".matrixblock"),u=Craft.MatrixInput.getCollapsedEntryIds();this.entrySort=new Garnish.DragSort(c,{handle:"> .actions > .move-btn",ignoreHandleSelector:null,axis:"y",filter:function(){return a.entrySort.$targetItem.hasClass("sel")?a.entrySelect.getSelectedItems():a.entrySort.$targetItem},collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,helperOpacity:.9,onDragStop:function(){a.trigger("entrySortDragStop")},onSortChange:function(){a.entrySelect.resetItemOrder()}}),this.entrySelect=new Garnish.Select(this.$entriesContainer,c,{multi:!0,vertical:!0,handle:"> .actions > .checkbox, > .titlebar",filter:function(t){return!o(t).closest(".tab-label").length},checkboxMode:!0});for(var h=0;h<c.length;h++){var f=o(c[h]),p=new Craft.MatrixInput.Entry(this,f);p.id&&-1!==o.inArray(""+p.id,u)&&p.collapse()}this.addListener(this.$addEntryBtn,"activate",s(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.$addEntryBtn.hasClass("loading")){t.next=2;break}return t.abrupt("return");case 2:return this.$addEntryBtn.addClass("loading"),Craft.cp.announce(Craft.t("app","Loading")),t.prev=4,t.next=7,this.addEntry(this.$addEntryBtn.data("type"));case 7:return t.prev=7,this.$addEntryBtn.removeClass("loading"),t.finish(7);case 10:case"end":return t.stop()}}),t,this,[[4,,7,10]])})))),this.$addEntryMenuBtn.length&&this.$addEntryMenuBtn.disclosureMenu().data("disclosureMenu").$container.find("button").on("activate",function(){var t=s(i().mark((function t(e){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a.$addEntryMenuBtn.addClass("loading"),Craft.cp.announce(Craft.t("app","Loading")),t.prev=2,t.next=5,a.addEntry(o(e.currentTarget).data("type"));case 5:return t.prev=5,a.$addEntryMenuBtn.removeClass("loading"),t.finish(5);case 8:case"end":return t.stop()}}),t,null,[[2,,5,8]])})));return function(e){return t.apply(this,arguments)}}()),this.updateAddEntryBtn(),setTimeout((function(){a.elementEditor=a.$container.closest("form").data("elementEditor"),a.elementEditor&&a.elementEditor.on("update",(function(){a.settings.ownerId=a.elementEditor.getDraftElementId(a.settings.ownerId)})),a.trigger("afterInit")}),100),this.$container.closest(".js-deletable").on("delete",(function(t){t.target===t.currentTarget&&a.destroy()})),Craft.cp.onCopyElements((function(t,e){a.updatePasteBtn(t),a.$pasteBtn&&e&&a.$pasteBtn.find(".label").text(e)}))},canAddMoreEntries:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return 0!==t&&(!this.maxEntries||this.$entriesContainer.children().length+t<=this.maxEntries)},canPaste:function(t){if(!this.canAddMoreEntries(t.length))return!1;var e,r=n(t);try{for(r.s();!(e=r.n()).done;)if("craft\\elements\\Entry"!==e.value.type)return!1}catch(t){r.e(t)}finally{r.f()}var i,a=this.entryTypes.map((function(t){return t.id})),s=n(t);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(!a.includes(o.data.entryTypeId))return!1}}catch(t){s.e(t)}finally{s.f()}return!0},pasteEntries:function(){var t=this;return s(i().mark((function e(){var n,r,a,s,l,d,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Craft.cp.announce(Craft.t("app","Loading")),t.$pasteBtn.addClass("loading"),e.prev=2,!t.elementEditor){e.next=6;break}return e.next=6,t.elementEditor.setFormValue(t.settings.baseInputName,"*");case 6:return e.next=8,Craft.cp.pasteElements({primaryOwnerId:t.settings.ownerId,ownerId:t.settings.ownerId,fieldId:t.settings.fieldId,siteId:t.settings.siteId});case 8:if((a=e.sent).length){e.next=11;break}return e.abrupt("return");case 11:return e.prev=11,e.next=14,Craft.sendActionRequest("POST","matrix/render-blocks",{data:{entryIds:a.map((function(t){return t.id})),siteId:t.settings.siteId,namespace:t.settings.namespace}});case 14:l=e.sent,s=l.data,e.next=22;break;case 18:return e.prev=18,e.t0=e.catch(11),Craft.cp.displayError(null===e.t0||void 0===e.t0||null===(d=e.t0.response)||void 0===d||null===(d=d.data)||void 0===d?void 0:d.message),e.abrupt("return");case 22:return e.next=24,null===(r=t.elementEditor)||void 0===r?void 0:r.pause();case 24:return c=o(s.blockHtml),t.$entriesContainer.append(c),e.next=28,Craft.appendHeadHtml(s.headHtml);case 28:return e.next=30,Craft.appendBodyHtml(s.bodyHtml);case 30:Craft.initUiElements(c),c.each((function(e,n){var r=o(n);new Craft.MatrixInput.Entry(t,r),t.trigger("entryAdded",{$entry:r})})),t.entrySort.addItems(c),t.entrySelect.addItems(c),t.updateAddEntryBtn(),Garnish.firstFocusableElement(c).focus();case 36:return e.prev=36,t.$pasteBtn.removeClass("loading"),e.finish(36);case 39:null===(n=t.elementEditor)||void 0===n||n.resume();case 40:case"end":return e.stop()}}),e,null,[[2,,36,39],[11,18]])})))()},updateAddEntryBtn:function(){this.canAddMoreEntries()?(this.$addEntryBtn.removeClass("disabled").removeAttr("aria-disabled"),this.$addEntryMenuBtn.removeClass("disabled")):(this.$addEntryBtn.addClass("disabled").attr("aria-disabled","true"),this.$addEntryMenuBtn.addClass("disabled")),this.updatePasteBtn()},updatePasteBtn:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e=e||Craft.cp.getCopiedElements(),this.canPaste(e)?this.$pasteBtn?this.$pasteBtn.removeClass("hidden"):(this.$pasteBtn=Craft.ui.createPasteButton().appendTo(this.$addEntryBtnContainer),this.addListener(this.$pasteBtn,"activate","pasteEntries")):null===(t=this.$pasteBtn)||void 0===t||t.addClass("hidden")},updateStatusMessage:function(){var t,e=this;this.$statusMessage.empty(),this.canAddMoreEntries()||(t=Craft.t("app","Entry could not be added. Maximum number of entries reached.")),setTimeout((function(){e.$statusMessage.text(t)}),250)},addEntry:function(t,e){var n=arguments,r=this;return s(i().mark((function a(){var l,d;return i().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(l=!(n.length>2&&void 0!==n[2])||n[2],d=n.length>3&&void 0!==n[3]?n[3]:{},r.canAddMoreEntries()){a.next=5;break}return r.updateStatusMessage(),a.abrupt("return");case 5:if(!r.elementEditor){a.next=8;break}return a.next=8,r.elementEditor.setFormValue(r.settings.baseInputName,"*");case 8:return a.next=10,Craft.queue.push(s(i().mark((function n(){var a,c,u,h;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r.addingEntry){n.next=2;break}return n.abrupt("return");case 2:return r.addingEntry=!0,n.next=5,Craft.sendActionRequest("POST","matrix/create-entry",{data:Object.assign({fieldId:r.settings.fieldId,entryTypeId:r.entryTypesByHandle[t].id,ownerId:r.settings.ownerId,ownerElementType:r.settings.ownerElementType,siteId:r.settings.siteId,namespace:r.settings.namespace,staticEntries:r.settings.staticEntries},d)});case 5:return c=n.sent,u=c.data,h=o(u.blockHtml),n.next=10,null===(a=r.elementEditor)||void 0===a?void 0:a.pause();case 10:null!=e&&e.length?h.insertBefore(e):h.appendTo(r.$entriesContainer),r.trigger("entryAdded",{$entry:h}),h.css(r.getHiddenEntryCss(h)).velocity({opacity:1,"margin-bottom":8},"fast",s(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return h.css("margin-bottom",""),t.next=3,Craft.appendHeadHtml(u.headHtml);case 3:return t.next=5,Craft.appendBodyHtml(u.bodyHtml);case 5:Craft.initUiElements(h.children(".fields")),new Craft.MatrixInput.Entry(r,h),r.entrySort.addItems(h),r.entrySelect.addItems(h),r.updateAddEntryBtn(),Garnish.requestAnimationFrame((function(){var t;l&&(Garnish.scrollContainerToElement(h),h.find(".flex-fields :focusable").not(".prevent-autofocus").first().focus()),null===(t=r.elementEditor)||void 0===t||t.resume()}));case 11:case"end":return t.stop()}}),t)})))),r.addingEntry=!1;case 14:case"end":return n.stop()}}),n)}))));case 10:case"end":return a.stop()}}),a)})))()},getEntryTypeByHandle:function(t){for(var e=0;e<this.entryTypes.length;e++)if(this.entryTypes[e].handle===t)return this.entryTypes[e]},collapseSelectedEntries:function(){this.callOnSelectedEntries("collapse")},expandSelectedEntries:function(){this.callOnSelectedEntries("expand")},disableSelectedEntries:function(){this.callOnSelectedEntries("disable")},enableSelectedEntries:function(){this.callOnSelectedEntries("enable")},deleteSelectedEntries:function(){this.callOnSelectedEntries("selfDestruct")},callOnSelectedEntries:function(t){for(var e=0;e<this.entrySelect.$selectedItems.length;e++)this.entrySelect.$selectedItems.eq(e).data("entry")[t]()},getHiddenEntryCss:function(t){return{opacity:0,marginBottom:-t.outerHeight()}},get maxEntries(){return this.settings.maxEntries},destroy:function(){var t,e;null===(t=this.entrySort)||void 0===t||t.destroy(),null===(e=this.entrySelect)||void 0===e||e.destroy(),delete this.entrySort,delete this.entrySelect,this.$entriesContainer.children(".matrixblock").each((function(t,e){var n;null===(n=o(e).data("entry"))||void 0===n||n.destroy()})),this.base()}},{defaults:{fieldId:null,maxEntries:null,namespace:null,baseInputName:null,ownerElementType:null,ownerId:null,siteId:null,staticEntries:!1},collapsedEntryStorageKey:"Craft-"+Craft.systemUid+".MatrixInput.collapsedEntries",getCollapsedEntryIds:function(){return"string"==typeof localStorage[Craft.MatrixInput.collapsedEntryStorageKey]?Craft.filterArray(localStorage[Craft.MatrixInput.collapsedEntryStorageKey].split(",")):[]},setCollapsedEntryIds:function(t){localStorage[Craft.MatrixInput.collapsedEntryStorageKey]=t.join(",")},rememberCollapsedEntryId:function(t){if("undefined"!=typeof Storage){var e=Craft.MatrixInput.getCollapsedEntryIds();-1===o.inArray(""+t,e)&&(e.push(t),Craft.MatrixInput.setCollapsedEntryIds(e))}},forgetCollapsedEntryId:function(t){if("undefined"!=typeof Storage){var e=Craft.MatrixInput.getCollapsedEntryIds(),n=o.inArray(""+t,e);-1!==n&&(e.splice(n,1),Craft.MatrixInput.setCollapsedEntryIds(e))}},initTabs:function(t){var e=o(t).children(".pane-tabs");if(e.length){var n=new Craft.Tabs(e),r=n.$menuBtn.data("trigger");return o(r.$container).find("li, a").on("click",(function(t){t.preventDefault()})),n.on("selectTab",(function(t){var e=t.$tab.attr("href");e&&"#"===e.charAt(0)&&o(e).removeClass("hidden"),Garnish.$win.trigger("resize"),Garnish.$doc.trigger("scroll")})),n.on("deselectTab",(function(t){var e=t.$tab.attr("href");e&&"#"===e.charAt(0)&&o(t.$tab.attr("href")).addClass("hidden")})),n}}}),Craft.MatrixInput.Entry=Garnish.Base.extend({matrix:null,$container:null,$titlebar:null,$tabContainer:null,$fieldsContainer:null,$previewContainer:null,$actionMenu:null,$collapsedInput:null,tabManager:null,actionDisclosure:null,formObserver:null,visibleLayoutElements:null,cancelToken:null,ignoreFailedRequest:!1,isNew:null,id:null,collapsed:!1,init:function(t,e){var n=this;this.matrix=t,this.$container=e,this.$titlebar=e.children(".titlebar"),this.$tabContainer=this.$titlebar.children(".matrixblock-tabs"),this.$previewContainer=this.$titlebar.children(".preview"),this.$fieldsContainer=e.children(".fields"),this.$container.data("entry",this),this.id=this.$container.data("id"),this.isNew=!this.id||"string"==typeof this.id&&"new"===this.id.substring(0,3),this.$tabContainer.length&&(this.tabManager=Craft.MatrixInput.initTabs(this.$tabContainer));var r=this.$container.find("> .actions > .action-btn"),i=r.data("disclosureMenu")||new Garnish.DisclosureMenu(r);this.$actionMenu=i.$container,this.actionDisclosure=i,i.on("show",(function(){n.$container.addClass("active");var t=[];n.collapsed?t.push("collapse"):t.push("expand"),n.$container.hasClass("disabled-entry")?t.push("disable"):t.push("enable"),n.$container.prev(".matrixblock").length||t.push("moveUp"),n.$container.next(".matrixblock").length||t.push("moveDown"),n.matrix.canAddMoreEntries()||t.push("add");var e=n.$actionMenu.find("button[data-action]"),r=t.length?e.filter(t.map((function(t){return"[data-action=".concat(t,"]")})).join(",")):o(),i=n.$actionMenu.data("disclosureMenu");r.each((function(t,e){i.hideItem(e)})),e.not(r).each((function(t,e){i.showItem(e)}))})),i.on("hide",(function(){n.$container.removeClass("active")})),this.$actionMenuOptions=this.$actionMenu.find("button[data-action]"),this.addListener(this.$actionMenuOptions,"activate",this.handleActionClick),Garnish.hasAttr(this.$container,"data-collapsed")&&this.collapse(),this._handleTitleBarClick=function(t){o(t.target).closest(".tab-label").length||(t.preventDefault(),this.toggle())},this.addListener(this.$titlebar,"doubletap",this._handleTitleBarClick),this.visibleLayoutElements=this.$container.data("visible-layout-elements"),this.formObserver=new Craft.FormObserver(this.$container,(function(t){n.updateFieldLayout(t)}))},toggle:function(){this.collapsed?this.expand():this.collapse(!0)},collapse:function(t){if(!this.collapsed){this.$container.addClass("collapsed");for(var e="",n=this.$fieldsContainer.children().children(),r=0;r<n.length;r++){for(var i=o(n[r]).children(".input").find('select,input[type!="hidden"],textarea,.label'),a="",s=0;s<i.length;s++){var l=o(i[s]),d=void 0;if(l.hasClass("label")){var c=l.closest(".lightswitch");if(c.length&&(c.hasClass("on")&&l.hasClass("off")||!c.hasClass("on")&&l.hasClass("on")))continue;if(l.closest("button[aria-pressed=false]").length)continue;d=l.text()}else d=Craft.getText(this._inputPreviewText(l));Array.isArray(d)&&(d=d.join(", ")),d&&(d=Craft.escapeHtml(d).trim())&&(a&&(a+=", "),a+=d)}a&&(e+=(e?" <span>|</span> ":"")+a)}this.$previewContainer.html(e),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop"),t&&!Garnish.prefersReducedMotion()?(this.$fieldsContainer.velocity("fadeOut",{duration:"fast"}),this.$container.velocity({height:30},"fast")):(this.$previewContainer.show(),this.$fieldsContainer.hide(),this.$container.css({height:30})),this.$tabContainer.hide(),this.isNew?this.$collapsedInput?this.$collapsedInput.val("1"):this.$collapsedInput=o('<input type="hidden" name="'+this.matrix.inputNamePrefix+"[entries]["+this.id+'][collapsed]" value="1"/>').appendTo(this.$container):Craft.MatrixInput.rememberCollapsedEntryId(this.id),this.collapsed=!0}},_inputPreviewText:function(t){if(t.is("select,multiselect")){for(var e=[],n=t.find("option:selected"),r=0;r<n.length;r++)e.push(n.eq(r).text());return e}if(t.is('input[type="checkbox"]:checked,input[type="radio"]:checked')){var i=t.attr("id"),a=o('label[for="'.concat(i,'"]'));if(a.length)return a.text()}return Garnish.getInputPostVal(t)},expand:function(){var t=this;if(this.collapsed){this.$container.removeClass("collapsed"),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop");var e=this.$container.height();this.$container.height("auto"),this.$fieldsContainer.show();var n=this.$container.height(),r=this.$fieldsContainer.css("display")||"block";this.$container.height(e),this.$fieldsContainer.hide().velocity("fadeIn",{duration:"fast",display:r});var i=Garnish.prefersReducedMotion()?0:"fast";if(this.$container.velocity({height:n},i,(function(){t.$previewContainer.html(""),t.$container.height("auto"),t.$container.trigger("scroll"),t.$tabContainer.show()})),!this.isNew&&"undefined"!=typeof Storage){var a=Craft.MatrixInput.getCollapsedEntryIds(),s=o.inArray(""+this.id,a);-1!==s&&(a.splice(s,1),Craft.MatrixInput.setCollapsedEntryIds(a))}this.isNew?this.$collapsedInput&&this.$collapsedInput.val(""):Craft.MatrixInput.forgetCollapsedEntryId(this.id),this.collapsed=!1}},disable:function(){this.$container.children('input[name$="[enabled]"]:first').val(""),this.$container.addClass("disabled-entry"),this.collapse(!0)},enable:function(){this.$container.children('input[name$="[enabled]"]:first').val("1"),this.$container.removeClass("disabled-entry")},moveUp:function(){this.matrix.trigger("beforeMoveEntryUp",{entry:this});var t=this.$container.prev(".matrixblock");t.length&&(this.$container.insertBefore(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryUp",{entry:this})},moveDown:function(){this.matrix.trigger("beforeMoveEntryDown",{entry:this});var t=this.$container.next(".matrixblock");t.length&&(this.$container.insertAfter(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryDown",{entry:this})},handleActionClick:function(t){t.preventDefault(),this.onActionSelect(t.target)},onActionSelect:function(t){var e,n=this.matrix.entrySelect.totalSelected>1&&this.matrix.entrySelect.isSelected(this.$container),r=o(t);switch(r.data("action")){case"collapse":n?this.matrix.collapseSelectedEntries():this.collapse(!0);break;case"expand":n?this.matrix.expandSelectedEntries():this.expand();break;case"disable":n?this.matrix.disableSelectedEntries():this.disable();break;case"enable":n?this.matrix.enableSelectedEntries():(this.enable(),this.expand());break;case"moveUp":this.moveUp();break;case"moveDown":this.moveDown();break;case"add":var i=r.data("type");this.matrix.addEntry(i,this.$container);break;case"duplicate":var a=this.$container.data("type"),s=this.matrix.elementEditor;this.matrix.addEntry(a,this.$container.next(".matrixblock"),!0,{duplicate:(null==s?void 0:s.getDraftElementId(this.id))||this.id});break;case"copy":var l;Craft.cp.copyElements([{type:"craft\\elements\\Entry",id:(null===(l=this.matrix.elementEditor)||void 0===l?void 0:l.getDraftElementId(this.id))||this.id,draftId:this.$container.data("draftId"),revisionId:this.$container.data("revisionId"),fieldId:this.matrix.settings.fieldId,ownerId:this.matrix.settings.ownerId,siteId:this.matrix.settings.siteId}]);break;case"delete":n?confirm(Craft.t("app","Are you sure you want to delete the selected entries?"))&&this.matrix.deleteSelectedEntries():this.selfDestruct()}null===(e=this.actionDisclosure)||void 0===e||e.hide()},selfDestruct:function(){var t=this;this.destroy(),o("[name]",this.$container).removeAttr("name"),this.$container.velocity(this.matrix.getHiddenEntryCss(this.$container),"fast",(function(){t.$container.remove(),t.matrix.updateAddEntryBtn(),t.matrix.trigger("entryDeleted",{$entry:t.$container})}))},updateFieldLayout:function(t){var n=this;return new Promise((function(r,i){var a,s=n.matrix.elementEditor,l=n.$container.data("base-input-name");if(null!=s&&s.submittingForm)i("Form already being submitted.");else{n.cancelToken&&(n.ignoreFailedRequest=!0,n.cancelToken.cancel());var d=function(t){return Craft.namespaceInputName(t,l)},c=e(e(e(e(e(e(e({},d("visibleLayoutElements"),n.visibleLayoutElements),d("elementType"),"craft\\elements\\Entry"),d("ownerId"),n.matrix.settings.ownerId),d("fieldId"),n.matrix.settings.fieldId),d("sortOrder"),n.$container.index()+1),d("typeId"),n.$container.data("type-id")),d("elementUid"),null!==(a=null==s?void 0:s.getDraftElementUid(n.$container.data("uid")))&&void 0!==a?a:n.$container.data("uid")),u=n.$fieldsContainer.children("[data-layout-tab]:not(.hidden)").data("id");u&&(c[d("selectedTab")]=u),t+="&".concat(o.param(c)),n.cancelToken=axios.CancelToken.source(),Craft.sendActionRequest("POST","elements/update-field-layout",{cancelToken:n.cancelToken.token,headers:{"content-type":"application/x-www-form-urlencoded","X-Craft-Namespace":l},data:t}).then((function(e){n._afterUpdateFieldLayout(t,u,l,e),r()})).catch((function(t){n.ignoreFailedRequest||i(t),n.ignoreFailedRequest=!1})).finally((function(){n.cancelToken=null}))}}))},_afterUpdateFieldLayout:function(t,e,r,a){var l=this;return s(i().mark((function t(){var s,d,c,u,h,f,p,y,m,v,g,b,$,E,x,C,w;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:d=l.$fieldsContainer.children("[data-layout-tab]:not(.hidden)").data("id"),c=o(),u={},h=n(a.data.missingElements);try{for(h.s();!(f=h.n()).done;){p=f.value,(y=l.$fieldsContainer.children('[data-layout-tab="'.concat(p.uid,'"]'))).length||(y=o("<div/>",{id:Craft.namespaceId(p.id,r),class:"flex-fields","data-id":p.id,"data-layout-tab":p.uid}),p.id!==e&&y.addClass("hidden"),y.appendTo(l.$fieldsContainer)),c=c.add(y),m=n(p.elements);try{for(m.s();!(v=m.n()).done;)!1!==(g=v.value).html?(u[p.uid]||(u[p.uid]=[]),u[p.uid].push(g.uid),"string"==typeof g.html&&(b=y.children('[data-layout-element="'.concat(g.uid,'"]')),$=o(g.html),b.length?b.replaceWith($):$.appendTo(y),Craft.initUiElements($))):(E=y.children('[data-layout-element="'.concat(g.uid,'"]'))).length&&Garnish.hasAttr(E,"data-layout-element-placeholder")||(x=o("<div/>",{class:"hidden","data-layout-element":g.uid,"data-layout-element-placeholder":""}),E.length?E.replaceWith(x):x.appendTo(y))}catch(t){m.e(t)}finally{m.f()}}}catch(t){h.e(t)}finally{h.f()}return(C=l.$fieldsContainer.children("[data-layout-tab]").not(c).not('[data-layout-tab=""]')).length&&C.remove(),c.filter(":not(.hidden)").length||c.first().removeClass("hidden"),l.visibleLayoutElements=u,l.tabManager&&(l.tabManager.destroy(),l.tabManager=null,l.$tabContainer.html("")),l.hasTabs=!!a.data.tabs,l.hasTabs&&(l.$tabContainer.append(a.data.tabs),l.tabManager=Craft.MatrixInput.initTabs(l.$tabContainer),e&&d&&e!==d&&((w=l.tabManager.$tabs.filter('[data-id="'.concat(d,'"]'))).length?l.tabManager.selectTab(w):l.tabManager.selectTab(l.tabManager.$tabs.first()))),t.next=15,Craft.appendHeadHtml(a.data.headHtml);case 15:return t.next=17,Craft.appendBodyHtml(a.data.bodyHtml);case 17:null===(s=l.matrix.elementEditor)||void 0===s||s.handleDismissibleTips();case 18:case"end":return t.stop()}}),t)})))()},destroy:function(){var t,e,n,r;null===(t=this.actionDisclosure)||void 0===t||t.hide(),null===(e=this.tabManager)||void 0===e||e.destroy(),null===(n=this.actionDisclosure)||void 0===n||n.destroy(),null===(r=this.formObserver)||void 0===r||r.destroy(),delete this.tabManager,delete this.actionDisclosure,delete this.formObserver,this.$container.trigger("delete"),this.base()}})}();
//# sourceMappingURL=MatrixInput.js.map